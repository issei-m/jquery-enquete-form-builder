/*!
 * jQuery Enquete Form Builder Plug-In
 * http://tetsuwo.tumblr.com/
 *
 * Copyright 2012, Tetsuwo OISHI
 * Dual licensed under the MIT license.
 *
 * @createdAt 2012-10-15
 * @see https://github.com/tetsuwo/jquery-enquete-form-builder
 */
(function(e){e.fn.enqueteFormBuilder=function(m,h){var g=e(this),a=null,f={},k=0,l=0,j=0,f=e.extend({debug:!1,itemTitleChars:10,minItem:0,maxItem:10,minOption:0,maxOption:10,ellipsis:"...",formNamePrefix:"enquete",classNamePrefix:"jq-enquete-fb-"},m);h=e.extend({title:"\u8cea\u554f\u6587\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002",deleteConfirm:"\u672c\u5f53\u306b\u524a\u9664\u3057\u307e\u3059\u304b\uff1f"},h);this.debug=function(a){f.debug&&console.log(a)};this.getConfig=function(){return f};
this.setPointer=function(c){a.debug("setPointer = "+c);j=c;return a.getPointer()};this.getPointer=function(){a.debug("getPointer = "+j);return j};this.validateItem=function(c,b){var d=a.getItem(c).find(a.getClassName("form-"+b,!0));return!d||""==d.val()?(a.setItem(c),d.focus(),alert(h[b]),!1):!0};this.validateAll=function(){var c=!0;a.getItems().each(function(){var b=e(this).attr("data-id");if(!a.validateItem(b,"title"))return c=!1});return c};this.loadDefaultItems=function(c){e.each(c,function(){a.addItem(!0,
this.id);a.applyItemContents(this.id,this)})};this.applyItemTitle=function(c,b){b&&f.itemTitleChars<b.length&&(b=b.substr(0,f.itemTitleChars)+f.ellipsis);a.getItem(c).find(a.getClassName("title",!0)).text(b)};this.applyItemContents=function(c,b){a.debug("applyItemContents");var d=a.getItem(c);b.id&&d.find('[name$="[id]"]').val(b.id);b.title&&(d.find('[name$="[title]"]').val(b.title),a.applyItemTitle(c,b.title));b.isRequired&&d.find('[name$="[isRequired]"]').attr("checked",b.isRequired);b.type&&d.find('[name$="[type]"]').find('option[value="'+
b.type+'"]').attr("selected",!0);"boolean"===typeof b.isNew&&d.find('[name$="[isNew]"]').val(b.isNew?"1":"0");"boolean"===typeof b.isDeleted&&d.find('[name$="[isDeleted]"]').val(b.isDeleted?"1":"0");b.note&&d.find('[name$="[note]"]').val(b.note);b.options&&0<b.options.length&&(a.applyOptions(c,b.options),a.toggleOption(c,b.type))};this.applyOptions=function(c,b){a.debug("applyOptions");var d=a.getItem(c),f=null;e.each(b,function(){a.addOption(c,!0,this.id);f=d.find('[data-id="'+this.id+'"]');this.id&&
f.find('[name$="[id]"]').val(this.id);this.content&&f.find('[name$="[content]"]').val(this.content);"boolean"===typeof this.isNew&&f.find('[name$="[isNew]"]').val(this.isNew?"1":"0");"boolean"===typeof this.isDeleted&&f.find('[name$="[isDeleted]"]').val(this.isDeleted?"1":"0")})};this.getClassName=function(a,b){return(b?".":"")+f.classNamePrefix+a};this.enableItem=function(c,b){a.getItem(c).find("input, select").attr("disabled",!b)};this.createItemNumber=function(){return k};this.createItemId=function(a){return"new-item-"+
a};this.createOptionNumber=function(){return l};this.createOptionId=function(a){return"new-option-"+a};this.createItemFormName=function(a){return f.formNamePrefix+"["+a+"]"};this.replaceFormName=function(c,b,d){var f=a.createItemFormName(b);c.find("input, select").each(function(){e(this).attr("name",e(this).attr("name").replace(/%baseName%/g,f).replace(/%optionId%/g,d))})};this.addItem=function(c,b){a.debug("addItem");if(f.maxItem&&f.maxItem<=a.getItems().length)return alert("\u8cea\u554f\u306f"+
f.maxItem+"\u500b\u307e\u3067\u8ffd\u52a0\u3067\u304d\u307e\u3059\u3002");var d=a.createItemNumber();b=!0===c?b:a.createItemId(d);var e=g.find(a.getClassName("item-tmpl",!0)).clone();e.attr("data-id",b).removeClass(a.getClassName("item-tmpl")).addClass(a.getClassName("item")).find("span").text(e.find("span").text().replace("%d",!0===c?d:d+1));g.find(a.getClassName("items",!0)).find("ul").eq(0).append(e);d=g.find(a.getClassName("content-tmpl",!0)).clone();d.attr("data-id",b).removeClass(a.getClassName("content-tmpl")).addClass(a.getClassName("content"));
a.replaceFormName(d,b);g.find(a.getClassName("contents",!0)).find("ul").eq(0).append(d);a.setItem(b);a.enableItem(b,!0);k++};this.deleteItem=function(c){a.debug("deleteItem");if(!confirm(h.deleteConfirm))return!1;c=a.getItem(c);var b=c.clone();c.remove();b.removeClass(a.getClassName("item"));b.find('[name$="[isDeleted]"]').val(1);g.find(a.getClassName("trashes",!0)).append(b);c=a.getItems();a.debug(c.eq(0));0<c.length&&a.setItem(c.eq(0).attr("data-id"));return!1};this.getItems=function(){return g.find(a.getClassName("item",
!0))};this.getContents=function(){return g.find(a.getClassName("content",!0))};this.getItem=function(c){return a.getItems().andSelf().find("[data-id="+c+"]")};this.getCurrentItem=function(){return a.getItem(j)};this.setItem=function(c){g.find(a.getClassName("content",!0)).hide();g.find(a.getClassName("item-focus",!0)).removeClass(a.getClassName("item-focus"));var b=a.getItem(c);b.eq(0).addClass(a.getClassName("item-focus"));b.show();a.setPointer(c)};this.getCurrentPositionInItems=function(c){a.debug("getCurrentPositionInItems");
var b=0;g.find(a.getClassName("item",!0)).each(function(a){if(e(this).attr("data-id")==c)return b=a,!1});a.debug("position = "+b);return b};this.moveUpItem=function(c){a.debug("moveUpItem = "+c);var b,d;c=a.getCurrentPositionInItems(c);b=a.getItems().eq(c);d=a.getItems().eq(c-1);if(!c)return!1;b.replaceWith(d.clone());d.replaceWith(b.clone());b=a.getContents().eq(c);d=a.getContents().eq(c-1);b.replaceWith(d.clone());d.replaceWith(b.clone())};this.moveDownItem=function(c){a.debug("moveDownItem = "+
c);var b,d;c=a.getCurrentPositionInItems(c);b=a.getItems().eq(c);d=a.getItems().eq(c+1);if(!d.length)return!1;b.replaceWith(d.clone());d.replaceWith(b.clone());b=a.getContents().eq(c);d=a.getContents().eq(c+1);b.replaceWith(d.clone());d.replaceWith(b.clone())};this.getCurrentOptions=function(){return a.getCurrentItem().find(a.getClassName("option",!0))};this.getOption=function(c){return a.getCurrentOptions().andSelf().find("[data-id="+c+"]")};this.addOption=function(c,b,d){a.debug("addOption");if(f.maxOption&&
f.maxOption<=a.getCurrentOptions().length)return alert("\u8cea\u554f\u306e\u9078\u629e\u80a2\u306f"+f.maxOption+"\u500b\u307e\u3067\u8ffd\u52a0\u3067\u304d\u307e\u3059\u3002");var e=a.createOptionNumber();d=!0===b?d:a.createOptionId(e);b=g.find(a.getClassName("option-tmpl",!0)).clone();b.attr("data-id",d).removeClass(a.getClassName("option-tmpl")).addClass(a.getClassName("option")).find("input").attr("disabled",!1);a.replaceFormName(b,c,d);a.getItem(c).find(a.getClassName("form-options",!0)).find("ul").eq(0).append(b);
l++};this.deleteOption=function(c){a.debug("deleteOption");if(!confirm(h.deleteConfirm))return!1;c=a.getOption(c);var b=c.clone();c.remove();b.removeClass(a.getClassName("form-option"));b.find('[name$="[isDeleted]"]').val(1);g.find(a.getClassName("trashes",!0)).append(b);return!1};this.getCurrentPositionInOptions=function(c){a.debug("getCurrentPositionInOptions");var b=0;a.getCurrentItem().find(a.getClassName("option",!0)).each(function(a){if(e(this).attr("data-id")==c)return b=a,!1});a.debug("position = "+
b);return b};this.moveUpOption=function(c){a.debug("moveUpOption = "+c);var b,d;c=a.getCurrentPositionInOptions(c);b=a.getCurrentOptions().eq(c);d=a.getCurrentOptions().eq(c-1);if(!c)return!1;b.replaceWith(d.clone());d.replaceWith(b.clone())};this.moveDownOption=function(c){a.debug("moveDownOption = "+c);var b;b=a.getCurrentPositionInOptions(c);c=a.getCurrentOptions().eq(b);b=a.getCurrentOptions().eq(b+1);if(!b.length)return!1;c.replaceWith(b.clone());b.replaceWith(c.clone())};this.toggleOption=function(c,
b){a.debug("toggleOption");var d=a.getItem(c).find(a.getClassName("form-options",!0));switch(b.toUpperCase()){case "SELECT":case "RADIO":case "CHECKBOX":a.debug(d.find("li"));1>d.find("li").length&&a.addOption(c);d.show();break;default:d.hide()}};this.debug(f);a=this;f.defaultItems&&("object"===typeof f.defaultItems&&0<f.defaultItems.length)&&a.loadDefaultItems(f.defaultItems);e(function(){var c=a.getItems(),b=e(g,document);1>c.length&&a.addItem();g.find(a.getClassName("add-item",!0)).click(function(){a.validateAll()&&
a.addItem()});b.off("click",a.getClassName("add-option",!0)).on("click",a.getClassName("add-option",!0),function(){a.addOption(e(this).parent().parent().attr("data-id"))});b.off("click",a.getClassName("item",!0)).on("click",a.getClassName("item",!0),function(){a.validateAll()&&a.setItem(e(this).attr("data-id"))});b.off("click",a.getClassName("up-item",!0)).on("click",a.getClassName("up-item",!0),function(b){a.moveUpItem(e(this).parent().attr("data-id"));b.stopPropagation()});b.off("click",a.getClassName("down-item",
!0)).on("click",a.getClassName("down-item",!0),function(b){a.moveDownItem(e(this).parent().attr("data-id"));b.stopPropagation()});b.off("click",a.getClassName("del-item",!0)).on("click",a.getClassName("del-item",!0),function(b){a.deleteItem(e(this).parent().attr("data-id"));b.stopPropagation()});b.off("click",a.getClassName("up-option",!0)).on("click",a.getClassName("up-option",!0),function(b){a.moveUpOption(e(this).parent().attr("data-id"));b.stopPropagation()});b.off("click",a.getClassName("down-option",
!0)).on("click",a.getClassName("down-option",!0),function(b){a.moveDownOption(e(this).parent().attr("data-id"));b.stopPropagation()});b.off("click",a.getClassName("del-option",!0)).on("click",a.getClassName("del-option",!0),function(b){a.deleteOption(e(this).parent().attr("data-id"));b.stopPropagation()});b.off("change",a.getClassName("form-title",!0)).on("change",a.getClassName("form-title",!0),function(){var b=e(this).parent().parent().attr("data-id"),c=e(this).val();if(!a.validateItem(b,"title"))return!1;
a.applyItemTitle(b,c)});b.off("change",a.getClassName("form-type",!0)).on("change",a.getClassName("form-type",!0),function(){var b=e(this).parent().parent().attr("data-id"),c=e(this).val();a.debug("form-type-change()");a.debug(b);a.debug(c);e(this).find('option[value="'+c+'"]').attr("selected",!0);a.debug(e(this));a.toggleOption(b,c)})});return this}})(jQuery);
